---
phase: 02-scanner
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - utils/scanner.ts
  - utils/messaging.ts
  - tests/scanner.test.ts
autonomous: true
requirements:
  - SCAN-01
  - SCAN-02
  - SCAN-04
  - SCAN-07

must_haves:
  truths:
    - "findInvisibleChars detects Tags block characters and returns findings with correct UTF-16 offsets, decoded ASCII replacement text, and type 'tags'"
    - "findInvisibleChars detects zero-width characters and returns findings with codepoint labels like [U+200B] and type 'zerowidth'"
    - "Adjacent Tags block characters are merged into a single finding with the full decoded message"
    - "Messaging protocol defines ping, startScan, and clearScan messages with typed responses"
  artifacts:
    - path: "utils/scanner.ts"
      provides: "Pure scanner functions: findInvisibleChars, decodeTagsRun"
      exports: ["findInvisibleChars", "decodeTagsRun", "ScanFinding"]
    - path: "utils/messaging.ts"
      provides: "Type-safe messaging protocol using @webext-core/messaging"
      exports: ["sendMessage", "onMessage", "ScanResult"]
    - path: "tests/scanner.test.ts"
      provides: "Unit tests for scanner pure functions"
      min_lines: 60
  key_links:
    - from: "utils/scanner.ts"
      to: "utils/charsets.ts"
      via: "buildDetectionRegex import"
      pattern: "import.*buildDetectionRegex.*from.*charsets"
    - from: "utils/messaging.ts"
      to: "@webext-core/messaging"
      via: "defineExtensionMessaging import"
      pattern: "defineExtensionMessaging"
---

<objective>
TDD implementation of the pure scanner logic that detects invisible Unicode characters in text and the type-safe messaging protocol for background/content script communication.

Purpose: Establish the tested, pure-function core that the content script and background service worker will consume. Scanner logic must be DOM-free so it can be unit tested without browser APIs.

Output: `utils/scanner.ts` with findInvisibleChars and decodeTagsRun, `utils/messaging.ts` with ProtocolMap, `tests/scanner.test.ts` with comprehensive tests.
</objective>

<execution_context>
@C:/Users/jozwi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/jozwi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-scanner/02-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@utils/charsets.ts
@utils/codec.ts
@utils/types.ts
</context>

<feature>
  <name>Scanner pure functions and messaging protocol</name>
  <files>utils/scanner.ts, utils/messaging.ts, tests/scanner.test.ts</files>
  <behavior>
    findInvisibleChars(text, sensitivity) scans a string for invisible Unicode characters and returns ScanFinding[].

    Each ScanFinding has: start (UTF-16 offset), end (UTF-16 offset, exclusive), original (the invisible chars), replacement (human-readable text), type ('tags' | 'zerowidth').

    Cases:
    - Empty string → []
    - "hello" (no invisible chars) → []
    - String with Tags block chars encoding "secret" → [{ start, end, original, replacement: "secret", type: 'tags' }]
    - String with single U+200B → [{ ..., replacement: "[U+200B]", type: 'zerowidth' }]
    - String with U+200C → [{ ..., replacement: "[U+200C]", type: 'zerowidth' }]
    - String with U+200D → [{ ..., replacement: "[U+200D]", type: 'zerowidth' }]
    - String with U+FEFF → [{ ..., replacement: "[U+FEFF]", type: 'zerowidth' }]
    - Mixed visible + Tags block + zero-width → multiple findings, correct offsets, no overlap
    - Adjacent Tags block chars → merged into one finding with full decoded text
    - Tags block wrapper chars (U+E0001, U+E007F) should be included in Tags findings but NOT decoded to ASCII (they are non-content Tags chars)
    - Sensitivity 'thorough' detects variation selectors (U+FE00-FE0F), word joiner (U+2060-2064)
    - Sensitivity 'paranoid' detects directional overrides (U+202A-202E), soft hyphen (U+00AD), etc.

    decodeTagsRun(text) decodes a run of Tags block characters to readable ASCII:
    - Tags content chars (U+E0020-E007E) → ASCII by subtracting 0xE0000
    - Wrapper chars (U+E0001, U+E007F) → silently skipped
    - Other Tags block chars → silently skipped

    Messaging protocol (utils/messaging.ts):
    - ProtocolMap interface with: ping() → 'pong', startScan() → ScanResult { count: number }, clearScan() → void
    - Export sendMessage and onMessage from defineExtensionMessaging
    - Export ScanResult type
  </behavior>
  <implementation>
    utils/scanner.ts:
    - Import buildDetectionRegex and SensitivityLevel from charsets.ts
    - Export ScanFinding interface
    - Export findInvisibleChars(text, sensitivity): uses buildDetectionRegex to get a regex, iterates matches with regex.exec(), merges adjacent Tags block matches into single findings, produces replacement text (decoded ASCII for tags, [U+XXXX] labels for zero-width)
    - Export decodeTagsRun(text): iterates codepoints, maps Tags content range to ASCII, skips wrappers and other Tags chars
    - Use regex.exec() loop (not for...of) to get UTF-16 offsets compatible with Text.splitText()
    - Tags block chars are surrogate pairs (2 UTF-16 code units each) — match.index and match[0].length are already in UTF-16 units

    utils/messaging.ts:
    - Import defineExtensionMessaging from @webext-core/messaging
    - Define ProtocolMap interface with ping, startScan, clearScan
    - Export ScanResult interface
    - Export sendMessage and onMessage

    Merging logic for adjacent Tags block characters:
    - After collecting all regex matches, do a second pass: if a Tags match ends where the next Tags match starts, merge them into one finding
    - The merged finding's replacement is decodeTagsRun(merged original)
  </implementation>
</feature>

<verification>
pnpm test -- tests/scanner.test.ts
pnpm lint
pnpm compile
</verification>

<success_criteria>
- All scanner tests pass (expect 15+ test cases)
- findInvisibleChars correctly detects Tags block and zero-width characters with accurate UTF-16 offsets
- Adjacent Tags block characters are merged into single findings
- Zero-width characters produce [U+XXXX] labels
- Messaging protocol compiles with typed ProtocolMap
- No new npm dependencies added
- Lint and TypeScript compilation clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-scanner/02-01-SUMMARY.md`
</output>
