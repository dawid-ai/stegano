---
phase: 04-popup-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - utils/clipboard.ts
  - entrypoints/popup/index.html
  - entrypoints/popup/main.tsx
  - entrypoints/popup/App.tsx
  - entrypoints/popup/style.css
autonomous: true
requirements:
  - CONV-01
  - CONV-02
  - CONV-03
  - CONV-04
  - CONV-05

must_haves:
  truths:
    - "User types text into encode field, clicks Encode, and sees invisible Unicode output with a character count confirming encoding succeeded"
    - "User pastes invisible Unicode into decode field and sees readable plaintext output automatically"
    - "User clicks Copy and sees a 'Copied!' confirmation that auto-clears after 2 seconds"
    - "If Clipboard API fails, the fallback execCommand copy still works via the same button"
    - "User clicks Clear and both input and output fields reset to empty"
  artifacts:
    - path: "utils/clipboard.ts"
      provides: "Clipboard write with async API + execCommand fallback"
      exports: ["copyToClipboard"]
    - path: "entrypoints/popup/index.html"
      provides: "WXT popup HTML entrypoint with root div"
      contains: "id=\"root\""
    - path: "entrypoints/popup/main.tsx"
      provides: "Preact render mount point"
      contains: "render("
    - path: "entrypoints/popup/App.tsx"
      provides: "Encode/decode converter UI with copy and clear"
      exports: ["App"]
    - path: "entrypoints/popup/style.css"
      provides: "Tailwind CSS v4 import and popup dimensions"
      contains: "@import \"tailwindcss\""
  key_links:
    - from: "entrypoints/popup/App.tsx"
      to: "utils/codec.ts"
      via: "direct import of encode() and decode()"
      pattern: "import.*encode.*decode.*codec"
    - from: "entrypoints/popup/App.tsx"
      to: "utils/clipboard.ts"
      via: "direct import of copyToClipboard()"
      pattern: "import.*copyToClipboard.*clipboard"
    - from: "entrypoints/popup/main.tsx"
      to: "entrypoints/popup/App.tsx"
      via: "Preact render() mounting App component"
      pattern: "render\\(<App"
---

<objective>
Build the complete popup converter UI — encode text to invisible Unicode, decode invisible Unicode to plaintext, copy to clipboard with fallback, and clear/reset fields.

Purpose: This is the primary user-facing interface. Users interact with the popup to create and read invisible Unicode text.
Output: Working popup with encode, decode, copy, and clear functionality accessible from the extension icon.
</objective>

<execution_context>
@C:/Users/jozwi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/jozwi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-popup-ui/04-RESEARCH.md
@utils/codec.ts
@utils/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create clipboard utility and popup scaffold</name>
  <files>
    utils/clipboard.ts
    entrypoints/popup/index.html
    entrypoints/popup/main.tsx
    entrypoints/popup/style.css
  </files>
  <action>
1. Create `utils/clipboard.ts` with a single exported async function `copyToClipboard(text: string): Promise<boolean>`:
   - Try `navigator.clipboard.writeText(text)` first, return true on success
   - On catch, fall back to creating a hidden textarea, setting its value, selecting it, calling `document.execCommand('copy')`, removing the textarea, and returning the boolean result
   - The fallback textarea must be positioned fixed with left: -9999px to stay offscreen

2. Create `entrypoints/popup/index.html`:
   - Standard HTML5 boilerplate with `<meta charset="UTF-8">` and viewport meta
   - `<title>InvisibleUnicode</title>`
   - A single `<div id="root"></div>` in the body
   - A `<script type="module" src="./main.tsx"></script>` tag
   - No inline styles or other elements

3. Create `entrypoints/popup/main.tsx`:
   - Import `render` from `preact`
   - Import `App` from `./App`
   - Import `./style.css`
   - Call `render(<App />, document.getElementById('root')!)`

4. Create `entrypoints/popup/style.css`:
   - Single `@import "tailwindcss";` directive
   - Add body rule: `width: 380px; min-height: 480px;`
   - No other custom CSS needed — all styling via Tailwind utility classes in components
  </action>
  <verify>
Run `pnpm build` — confirm no errors and that `.output/chrome-mv3/popup.html` exists in the build output.
  </verify>
  <done>
Clipboard utility exports copyToClipboard with async API + execCommand fallback. Popup entrypoint files exist and WXT auto-generates default_popup in the manifest. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build encode/decode converter App component with copy and clear</name>
  <files>
    entrypoints/popup/App.tsx
  </files>
  <action>
Create `entrypoints/popup/App.tsx` as the root popup component using Preact + Tailwind. The component implements all five CONV requirements:

**Layout:**
- Fixed width popup (380px set in CSS). Two sections stacked vertically: Encode section on top, Decode section below.
- Use a clean, minimal design with Tailwind utility classes. Light background (gray-50 or white), clear section separation.

**Encode Section (CONV-01):**
- A textarea for plaintext input. Placeholder: "Type or paste text to encode..."
- An "Encode" button that calls `encode(input)` from `@/utils/codec` on click (button-triggered, not live)
- Wrap the `encode()` call in try/catch. On error (non-ASCII input), display the error message in a red text paragraph below the button. Clear error when input changes.
- A readonly textarea for encoded output. Since Tags block chars are invisible, show a character count label below (e.g., "142 invisible characters") to confirm encoding succeeded. If output is empty, show nothing.

**Decode Section (CONV-02):**
- A textarea for invisible Unicode input. Placeholder: "Paste invisible Unicode to decode..."
- Auto-decode: call `decode(input)` on every `onInput` event (decode is safe to run live — it never throws). Import decode from `@/utils/codec`.
- A readonly textarea showing the decoded plaintext.

**Copy Button (CONV-03 + CONV-04):**
- A "Copy" button next to the encode output textarea (only enabled when encoded output is non-empty).
- On click, call `copyToClipboard(encodedOutput)` from `@/utils/clipboard`.
- On success: change button text to "Copied!" with a green color. Use `setTimeout` to revert after 2000ms. Store the timer ref via `useRef<number>(0)` and clear on re-click.
- On failure (copyToClipboard returns false): show "Copy failed" briefly in red. The fallback is already handled inside copyToClipboard — this is just the UI feedback path.

**Clear Button (CONV-05):**
- A single "Clear" button (visible in both sections or as a single button at the top/bottom).
- On click: set all state to empty strings — encode input, encode output, decode input, decode output, error message. Also clear the copied state and any pending timeout.

**State management:**
- Use `useState` from `preact/hooks` for: encodeInput, encodeOutput, decodeInput, decodeOutput, error, copied.
- Use `useRef` from `preact/hooks` for the copy confirmation timeout.
- No external state management. No persistence (popup state is transient by design).

**Imports:**
- `import { useState, useRef } from 'preact/hooks';`
- `import { encode, decode } from '@/utils/codec';`
- `import { copyToClipboard } from '@/utils/clipboard';`

**Anti-patterns to avoid:**
- Do NOT use dangerouslySetInnerHTML for any user-controlled text
- Do NOT import from 'react' — use 'preact' and 'preact/hooks' directly
- Do NOT add real-time encoding on every keystroke — use button-triggered encode
- Do NOT call decode() with a try/catch — decode never throws (it just returns cleaned text)
  </action>
  <verify>
Run `pnpm build` — confirm the popup builds with no TypeScript or bundling errors. Manually load the extension in Chrome, click the icon, verify the popup opens at 380px width with encode/decode sections visible. Type "hello", click Encode, confirm character count shows. Click Copy, confirm "Copied!" feedback. Click Clear, confirm fields reset.
  </verify>
  <done>
User can encode text to invisible Unicode via button click with error handling for non-ASCII. User can paste invisible Unicode and see decoded plaintext. Copy button writes to clipboard with visual confirmation. Clear button resets all fields. Popup is styled with Tailwind and has stable fixed dimensions.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with no errors
2. Built extension at `.output/chrome-mv3/` contains `popup.html`
3. Loading the extension in Chrome: clicking icon opens the popup at ~380px width
4. Encode flow: type "test" → click Encode → output shows "52 invisible characters" count → click Copy → "Copied!" confirmation appears → paste elsewhere confirms invisible text was copied
5. Decode flow: paste Tags block text into decode field → plaintext appears in output
6. Error handling: type emoji or non-ASCII → encode shows error message → modify input → error clears
7. Clear: click Clear → all fields empty, no error, no copied state
</verification>

<success_criteria>
All five CONV requirements are functional in the popup. The popup opens from the extension icon, encode/decode work correctly, copy writes to clipboard with confirmation, and clear resets everything. Build passes cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/04-popup-ui/04-01-SUMMARY.md`
</output>
