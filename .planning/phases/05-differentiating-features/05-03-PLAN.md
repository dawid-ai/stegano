---
phase: 05-differentiating-features
plan: 03
type: execute
wave: 2
depends_on:
  - 05-01
  - 05-02
files_modified:
  - utils/messaging.ts
  - utils/export.ts
  - entrypoints/content.ts
  - entrypoints/background.ts
  - entrypoints/popup/App.tsx
autonomous: true
requirements:
  - SNIP-02
  - SCAN-09

must_haves:
  truths:
    - "User presses a snippet's assigned keyboard shortcut and the snippet content is copied to clipboard"
    - "User clicks Export in the popup and gets a JSON report of scan findings copied to clipboard"
    - "Exported JSON contains url, timestamp, summary counts per class, and individual findings"
    - "Snippet shortcuts only fire when Alt+Shift prefix is held"
  artifacts:
    - path: "utils/export.ts"
      provides: "ScanReport type and buildScanReport function"
      exports: ["ScanReport", "buildScanReport"]
    - path: "utils/messaging.ts"
      provides: "getFindings and pasteSnippet message types"
      contains: "getFindings"
    - path: "entrypoints/content.ts"
      provides: "Snippet keydown listener and getFindings handler"
      contains: "keydown"
    - path: "entrypoints/popup/App.tsx"
      provides: "Export JSON button in popup"
      contains: "Export"
  key_links:
    - from: "entrypoints/popup/App.tsx"
      to: "entrypoints/content.ts"
      via: "sendMessage('getFindings') to retrieve scan findings"
      pattern: "sendMessage.*getFindings"
    - from: "entrypoints/content.ts"
      to: "utils/storage.ts"
      via: "reads snippetsSetting for shortcut matching"
      pattern: "snippetsSetting"
    - from: "entrypoints/popup/App.tsx"
      to: "utils/export.ts"
      via: "imports buildScanReport to format JSON"
      pattern: "buildScanReport"
---

<objective>
Wire snippet paste-via-keyboard-shortcut in the content script and add scan result export as JSON from the popup.

Purpose: Snippets are only useful if users can quickly paste them (SNIP-02). Scan results are only actionable if users can share or save them (SCAN-09). This plan connects the storage and scanner work from Plans 01-02 to user-facing features.

Output: Working keyboard shortcuts for snippet paste, and an Export JSON button in the popup that copies a structured scan report to clipboard.
</objective>

<execution_context>
@C:/Users/jozwi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/jozwi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-differentiating-features/05-RESEARCH.md
@.planning/phases/05-differentiating-features/05-01-SUMMARY.md
@.planning/phases/05-differentiating-features/05-02-SUMMARY.md
@utils/messaging.ts
@utils/clipboard.ts
@entrypoints/content.ts
@entrypoints/background.ts
@entrypoints/popup/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Snippet keydown listener and getFindings message handler in content script</name>
  <files>utils/messaging.ts, entrypoints/content.ts</files>
  <action>
**utils/messaging.ts — Add new message types:**

1. Add to `MessageMap`:
   ```typescript
   getFindings: {
     data: undefined;
     response: {
       findings: Array<{
         type: 'tags' | 'zerowidth' | 'watermark';
         replacement: string;
         original: string;
         codepoints: string[];
         position: { start: number; end: number };
       }>;
       url: string;
       timestamp: string;
     } | null;
   };
   ```
   The response is `null` when no scan has been performed. The `findings` array mirrors the content script's `allFindings` with serializable fields.

**entrypoints/content.ts — Add snippet keydown listener and getFindings handler:**

1. Import `snippetsSetting` from storage and `Snippet` type from types.

2. Add snippet state and loading:
   ```typescript
   let snippets: Snippet[] = [];
   snippetsSetting.getValue().then(s => { snippets = s; });
   snippetsSetting.watch(s => { snippets = s; });
   ```
   Place this inside `main()` so it runs when the content script loads.

3. Add keydown listener inside `main()`:
   ```typescript
   document.addEventListener('keydown', (e: KeyboardEvent) => {
     if (!e.altKey || !e.shiftKey) return; // Alt+Shift prefix required (per prior decision)

     const match = snippets.find(s =>
       s.shortcut &&
       s.shortcut.key.toLowerCase() === e.key.toLowerCase() &&
       s.shortcut.alt === e.altKey &&
       s.shortcut.shift === e.shiftKey &&
       !!s.shortcut.ctrl === e.ctrlKey
     );

     if (match) {
       e.preventDefault();
       e.stopPropagation();
       navigator.clipboard.writeText(match.content).catch(() => {
         // Clipboard write may fail if page doesn't have focus
       });
     }
   }, true); // useCapture to intercept before page handlers
   ```

4. Add `getFindings` message handler inside `main()`:
   ```typescript
   onMessage('getFindings', () => {
     if (!scanActive || allFindings.length === 0) return null;
     return {
       findings: allFindings.map(f => ({
         type: f.type,
         replacement: f.replacement,
         original: f.original,
         codepoints: [...f.original].map(ch =>
           'U+' + (ch.codePointAt(0) ?? 0).toString(16).toUpperCase().padStart(4, '0')
         ),
         position: { start: f.start, end: f.end },
       })),
       url: window.location.href,
       timestamp: new Date().toISOString(),
     };
   });
   ```
   This reads from the `allFindings` array populated by Plan 01's changes.
  </action>
  <verify>Run `pnpm build` — builds without errors. Content script includes keydown listener and getFindings handler.</verify>
  <done>Content script listens for Alt+Shift+key combos matching snippet shortcuts and copies content to clipboard. getFindings message returns structured findings data or null.</done>
</task>

<task type="auto">
  <name>Task 2: Export utility and popup Export JSON button</name>
  <files>utils/export.ts, entrypoints/popup/App.tsx</files>
  <action>
**utils/export.ts — Create scan report builder:**

```typescript
export interface ScanReport {
  version: 1;
  url: string;
  timestamp: string;
  summary: {
    total: number;
    tags: number;
    zerowidth: number;
    watermark: number;
  };
  findings: ScanReportFinding[];
}

interface ScanReportFinding {
  type: 'tags' | 'zerowidth' | 'watermark';
  replacement: string;
  codepoints: string[];
  position: { start: number; end: number };
}

export function buildScanReport(data: {
  findings: Array<{
    type: 'tags' | 'zerowidth' | 'watermark';
    replacement: string;
    original: string;
    codepoints: string[];
    position: { start: number; end: number };
  }>;
  url: string;
  timestamp: string;
}): ScanReport {
  const summary = { total: 0, tags: 0, zerowidth: 0, watermark: 0 };
  const reportFindings: ScanReportFinding[] = [];

  for (const f of data.findings) {
    summary.total++;
    summary[f.type]++;
    reportFindings.push({
      type: f.type,
      replacement: f.replacement,
      codepoints: f.codepoints,
      position: f.position,
    });
  }

  return {
    version: 1,
    url: data.url,
    timestamp: data.timestamp,
    summary,
    findings: reportFindings,
  };
}
```

**entrypoints/popup/App.tsx — Add Export JSON button:**

1. Import `sendMessage` from messaging, `buildScanReport` from export, `copyToClipboard` from clipboard, and `browser` from 'wxt/browser'.

2. Add state: `const [exportStatus, setExportStatus] = useState<'idle' | 'success' | 'empty' | 'fail'>('idle');`

3. Add `handleExport` function:
   - Get active tab via `browser.tabs.query({ active: true, currentWindow: true })`
   - Send `getFindings` message to the active tab
   - If response is null or findings empty, set exportStatus to 'empty' (show "No findings")
   - Otherwise, call `buildScanReport(response)` to create the report
   - Call `copyToClipboard(JSON.stringify(report, null, 2))`
   - Set exportStatus to 'success' or 'fail' based on result
   - Auto-reset status after 2 seconds

4. Add an "Export JSON" button in the popup UI. Place it in the header area next to "Clear All", or in a new section below the decode section. Use a small button matching the existing style. Show status text:
   - idle: "Export JSON"
   - success: "Copied!"
   - empty: "No scan results"
   - fail: "Export failed"

   Use clipboard copy as the PRIMARY export method (per research: file download from popup has focus-loss problem). This is sufficient for SCAN-09 which says "clipboard copy or file download".
  </action>
  <verify>Run `pnpm build` — builds without errors. Load extension, scan a page, open popup, click Export JSON — JSON is copied to clipboard with url, timestamp, summary, and findings array.</verify>
  <done>Export JSON button in popup copies a structured ScanReport to clipboard. Report includes version, url, timestamp, per-class summary counts, and individual findings with codepoints and positions.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- Snippet keyboard shortcuts paste content to clipboard when pressed on a web page
- Export JSON from popup produces valid JSON with ScanReport schema
- All three character classes (tags, zerowidth, watermark) appear correctly in exported JSON
</verification>

<success_criteria>
- Snippet shortcut Alt+Shift+key copies snippet content to clipboard
- Snippets load reactively from sync storage (changes on settings page take effect without reload)
- Export JSON button in popup copies structured report to clipboard
- Report includes per-class counts (tags, zerowidth, watermark) and individual findings
- "No scan results" shown when no scan has been performed
</success_criteria>

<output>
After completion, create `.planning/phases/05-differentiating-features/05-03-SUMMARY.md`
</output>
