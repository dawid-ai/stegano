---
phase: 03-service-worker-and-settings
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - entrypoints/content.ts
autonomous: true
requirements:
  - SETT-01

must_haves:
  truths:
    - "Changing highlight color in storage immediately updates all existing highlight spans on the page"
    - "Next scan after color change uses the new color without page reload"
    - "storage.watch() callback only runs in content script context (not background)"
  artifacts:
    - path: "entrypoints/content.ts"
      provides: "Reactive highlight color update via storage.watch()"
      contains: "highlightColorSetting.watch"
  key_links:
    - from: "entrypoints/content.ts"
      to: "utils/storage.ts"
      via: "highlightColorSetting.watch() callback updates DOM spans"
      pattern: "highlightColorSetting\\.watch"
---

<objective>
Add reactive highlight color updates to the content script so that changing the highlight color setting immediately updates all existing highlighted spans on the page without re-scanning or reloading.

Purpose: Users see their color preference take effect instantly on already-highlighted text.
Output: Updated content.ts with storage.watch() integration.
</objective>

<execution_context>
@C:/Users/jozwi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/jozwi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-service-worker-and-settings/03-RESEARCH.md
@entrypoints/content.ts
@utils/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reactive highlight color watching to content script</name>
  <files>entrypoints/content.ts</files>
  <action>
In `entrypoints/content.ts`, inside the `main()` function of `defineContentScript()`, add a `highlightColorSetting.watch()` call that reactively updates all existing highlight spans when the color changes.

Add this after the existing `onMessage` registrations:

```typescript
// Reactively update highlight color when setting changes (SETT-01)
highlightColorSetting.watch((newColor) => {
  const highlights = document.querySelectorAll<HTMLElement>('[data-iu-highlight]');
  for (const el of highlights) {
    el.style.backgroundColor = newColor;
  }
});
```

This callback fires whenever `highlightColorSetting` changes in sync storage (e.g., from the popup settings UI in Phase 4 or from `chrome://extensions` storage editor during testing). It updates every existing `[data-iu-highlight]` span's background color.

Per research Pitfall 6: this watch callback ONLY runs in the content script context (it queries DOM elements). The background service worker does not register this callback, so there is no "document is not defined" risk.

The `performFullScan()` function already reads `highlightColorSetting.getValue()` at scan start, so future scans automatically use the latest color. No changes needed there.

Also add `scanModeSetting` import (from `@/utils/storage`) and a watch for it that could be used for auto-scan behavior. For now, just watch it and update the module-level scan behavior:

```typescript
// Watch scan mode changes for future auto-scan support (SETT-02 persistence already handled by sync storage)
// The setting persists automatically via Chrome sync storage across sessions.
// Auto-scan behavior will be wired when Phase 4 adds the settings UI.
```

Actually, SETT-02 is already satisfied by the existing `scanModeSetting` using sync storage with `'onDemand'` fallback. It persists across sessions by definition. No content script changes are needed for SETT-02. Remove the scan mode watch and keep the content script focused on SETT-01 (highlight color reactivity).
  </action>
  <verify>Run `pnpm tsc --noEmit` for type checking. Run `pnpm vitest run` to confirm existing tests still pass. Verify that `highlightColorSetting.watch` is called inside `main()` of `defineContentScript()`. Run `pnpm wxt build` to confirm clean build.</verify>
  <done>Content script watches highlightColorSetting and updates all existing highlight spans immediately when the color changes. No re-scan or page reload needed. Existing tests pass.</done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes
2. `pnpm vitest run` â€” all existing tests pass
3. `pnpm wxt build` succeeds
4. `highlightColorSetting.watch()` is called inside `main()` of `defineContentScript()`
5. The watch callback queries `[data-iu-highlight]` and updates `backgroundColor`
</verification>

<success_criteria>
- Content script reactively updates highlight color on all existing spans when storage changes
- Next scan uses the new color (already handled by existing `performFullScan` reading from storage)
- No page reload required for color changes to take effect
- All existing tests pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/03-service-worker-and-settings/03-02-SUMMARY.md`
</output>
