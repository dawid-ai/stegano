---
phase: 03-service-worker-and-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - wxt.config.ts
  - entrypoints/background.ts
  - utils/storage.ts
autonomous: true
requirements:
  - KEYS-01
  - KEYS-02
  - KEYS-03
  - SETT-02

must_haves:
  truths:
    - "Manifest declares three keyboard shortcut commands (_execute_action, trigger-scan, quick-paste)"
    - "Pressing trigger-scan shortcut toggles page scan identical to clicking the extension icon"
    - "Pressing quick-paste shortcut copies the primary snippet to clipboard via content script injection"
    - "Scan mode setting is read from storage in background.ts determining on-demand vs auto behavior"
    - "All event listeners are synchronous top-level in defineBackground() surviving cold start"
  artifacts:
    - path: "wxt.config.ts"
      provides: "commands manifest key with _execute_action, trigger-scan, quick-paste"
      contains: "commands"
    - path: "entrypoints/background.ts"
      provides: "onCommand listener dispatching trigger-scan and quick-paste"
      contains: "commands.onCommand"
    - path: "utils/storage.ts"
      provides: "primarySnippetSetting for quick-paste feature"
      contains: "primarySnippet"
  key_links:
    - from: "wxt.config.ts"
      to: "entrypoints/background.ts"
      via: "manifest commands declaration -> onCommand listener"
      pattern: "trigger-scan|quick-paste"
    - from: "entrypoints/background.ts"
      to: "utils/storage.ts"
      via: "primarySnippetSetting.getValue() in quick-paste handler"
      pattern: "primarySnippetSetting"
---

<objective>
Add keyboard shortcut commands to the manifest and wire them to the background service worker. The extension icon shortcut opens the popup (when it exists in Phase 4), a scan shortcut triggers the same scan toggle as clicking the icon, and a quick-paste shortcut copies the primary snippet to clipboard.

Purpose: Users can operate the extension entirely via keyboard without clicking the icon.
Output: Updated wxt.config.ts with commands, updated background.ts with onCommand listener, primarySnippetSetting in storage.ts.
</objective>

<execution_context>
@C:/Users/jozwi/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/jozwi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-service-worker-and-settings/03-RESEARCH.md
@wxt.config.ts
@entrypoints/background.ts
@utils/storage.ts
@utils/messaging.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add commands to manifest and primarySnippetSetting to storage</name>
  <files>wxt.config.ts, utils/storage.ts</files>
  <action>
In `wxt.config.ts`, add a `commands` key inside the `manifest` object with three entries:

1. `_execute_action` with suggested_key `{ default: 'Ctrl+Shift+U', mac: 'Command+Shift+U' }` — no description needed (Chrome ignores it for this special command).

2. `trigger-scan` with suggested_key `{ default: 'Alt+Shift+S', mac: 'Command+Shift+S' }` and description `'Scan page for invisible characters'`.

3. `quick-paste` with suggested_key `{ default: 'Alt+Shift+V', mac: 'Command+Shift+V' }` and description `'Paste primary invisible text snippet'`.

Use `Alt+Shift+` prefix for custom commands on Windows/Linux to avoid conflicts with common browser shortcuts (per research). `_execute_action` uses `Ctrl+Shift+U` since that is the most discoverable mnemonic (U for Unicode).

In `utils/storage.ts`, add a new storage item:
```typescript
/** Primary invisible text snippet for quick-paste (KEYS-03). Phase 5 adds full snippet library. */
export const primarySnippetSetting = storage.defineItem<string>(
  'sync:primarySnippet',
  { fallback: '' },
);
```

This stores the most recently encoded text as the quick-paste target. Phase 5 will extend this to a full snippet library.
  </action>
  <verify>Run `pnpm wxt build` and inspect `.output/chrome-mv3/manifest.json` to confirm the `commands` key appears with all three entries and correct suggested_key values. Confirm `primarySnippetSetting` export exists in storage.ts. Run `pnpm tsc --noEmit` for type checking.</verify>
  <done>Manifest contains three commands with correct suggested keys. primarySnippetSetting is exported from storage.ts with sync storage and empty string fallback.</done>
</task>

<task type="auto">
  <name>Task 2: Wire onCommand listener and quick-paste handler in background.ts</name>
  <files>entrypoints/background.ts</files>
  <action>
Refactor `entrypoints/background.ts` to:

1. **Extract a shared `handleScanToggle(tabId, url)` function** from the existing `action.onClicked` handler body. This function takes `tabId: number` and `url: string | undefined`, performs the badge check, content script injection, scan toggle, and badge update. Both `action.onClicked` and the `trigger-scan` command will call this same function.

2. **Add `browser.commands.onCommand.addListener`** synchronously at the top level inside `defineBackground()` — alongside the existing `action.onClicked.addListener`. The listener receives `(command: string, tab?: Tabs.Tab)`. Switch on command:
   - `'trigger-scan'`: call `handleScanToggle(tab.id, tab.url)` if tab and tab.id exist and URL is not restricted.
   - `'quick-paste'`: call a new `handleQuickPaste(tabId: number)` function.

3. **Implement `handleQuickPaste(tabId)`**:
   - Import `primarySnippetSetting` from `@/utils/storage`.
   - Read the snippet: `const snippet = await primarySnippetSetting.getValue()`.
   - If snippet is empty, return early (nothing to paste).
   - Use `browser.scripting.executeScript()` to inject a function into the tab that calls `navigator.clipboard.writeText(snippet)`. The injected function receives the snippet string via the `args` array. Example:
     ```typescript
     await browser.scripting.executeScript({
       target: { tabId },
       func: (text: string) => navigator.clipboard.writeText(text),
       args: [snippet],
     });
     ```
   - Wrap in try/catch — clipboard write may fail on restricted pages or if page doesn't have focus.

4. **Import `scanModeSetting` from `@/utils/storage`** and add an `onInstalled` listener that logs the current scan mode. This confirms the setting is readable from the service worker context. (Auto-scan behavior itself is wired in Phase 2's content script and already works based on storage value.)

5. **Keep the existing `tabs.onUpdated` listener** for badge clearing on navigation. Ensure ALL `addListener` calls are synchronous and top-level within `defineBackground()` — no async wrapping, no conditional registration.

All event listeners MUST be registered synchronously at the top level of `defineBackground()` main function. This is critical for cold-start resilience (per research Pitfall 3).
  </action>
  <verify>Run `pnpm tsc --noEmit` to confirm no type errors. Run `pnpm wxt build` to confirm clean build. Manually verify in background.ts that all `addListener` calls are direct children of the `defineBackground(() => { ... })` block (not nested in async functions or conditionals).</verify>
  <done>background.ts has onCommand listener dispatching trigger-scan to handleScanToggle and quick-paste to handleQuickPaste. All listeners are top-level synchronous in defineBackground(). handleScanToggle is shared between onClicked and onCommand. handleQuickPaste reads primarySnippetSetting and writes to clipboard via scripting.executeScript.</done>
</task>

</tasks>

<verification>
1. `pnpm wxt build` succeeds without errors
2. Generated manifest.json contains `commands` with `_execute_action`, `trigger-scan`, `quick-paste`
3. `pnpm tsc --noEmit` passes
4. `pnpm vitest run` — existing tests still pass (no regressions)
5. All `addListener` calls in background.ts are synchronous top-level within `defineBackground()`
</verification>

<success_criteria>
- Manifest has three keyboard shortcut commands with correct suggested keys
- background.ts handles trigger-scan and quick-paste via onCommand
- Scan toggle logic is shared between icon click and keyboard shortcut
- Quick-paste reads from primarySnippetSetting and writes to clipboard via content script injection
- All event listeners survive service worker cold start (synchronous top-level registration)
- Existing tests pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/03-service-worker-and-settings/03-01-SUMMARY.md`
</output>
